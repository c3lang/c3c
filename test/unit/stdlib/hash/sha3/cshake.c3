// Copyright (c) 2025-2026 Zack Puhl <github@xmit.xyz>. All rights reserved.
// Use of this source code is governed by the MIT license
// a copy of which can be found in the LICENSE_STDLIB file.
module sha3::cshake_tests @test;

import sha3::tests_common;
import std::hash::sha3::cshake;


// See: https://github.com/usnistgov/ACVP-Server/tree/master/gen-val/json-files/cSHAKE-128-1.0
//   & https://github.com/usnistgov/ACVP-Server/tree/master/gen-val/json-files/cSHAKE-256-1.0
//
//  "internalProjection.json" files.
//
fn void cshake_known_vectors()
{
	/* tcId  5 */ test::@check(x"2eef41bd1680c16f36ae2b9c004805f7426ac9d4bb6bf7cfc78606a6e6f6f518eb6c0be7" == cshake::xof(128, 36, x"ea18", "fmkctMwhBB[<Kta&RJ5r5ToA9N9~Y-,kin8y]xB}kviaDk_kPI^{o#N1|JIF5x.67pR]]fGX)6'=j.{MnLN1M0zf@'|3OzirhSJS9#.i#&rXz1FnM{WgI|g'tk=Ui5*-L4T6cH4k?d.H<Bk/`.dRC#HklD_LeV~mz"));
	/* tcId 69 */ test::@check(x"799964e28f9a75f9c7e87c0842790ce03fe7743347fceddf1245ab913fa9a45cac8c1ac74af58b8dd3c0f7" == cshake::xof(128, 43, x"643d5d", "9[4gjE(d=h}TRAp@m1% -|+zH7caKBkA7L3 K6=]=vP(D(Q3yOdK&vC<Q8?SbE9z{[=&/psWsGc5L#UAdOgz]@<@)vM3vhyv]T,hiL%)Z,V^4.nNb}"));
	/* tcId 99 */ test::@check(x"8d6126c9e9cfe6acd2ce1e96a126038e1a7540e2f491d7e929d532480d961d800112307a09de39" == cshake::xof(128, 39, x"9d27db91871324c9d982419353a1b05ad4df57cdd074cf6eaa98063d63f71209ea", "D]uJi])MJ57z3e#h~b0#]wJekj^Em2f2>1#r`k/i%EH"));

	/* tcId  4 */ test::@check(x"e366bf084cf54999be6f1b30c928cb116892cdabc66f212865df60947521038ab2ef29e20c65eeb9f673e1" == cshake::xof(256, 43, "", "mr9dI%/rYePRx1ANU3uD7GpLM7,Ell%><H~dRw*v+w,e`[_aed*Rm8iF#l63wh'l`37P1]{])}9>;,kqVI`(cPO$^Xaebv~Bq>%MD/P(hKIo}K+u D[N)}*/b3qWz6z2~"));
	/* tcId 54 */ test::@check(x"95c357e292d2220f44bca02d48a1a9f83e47a1a895ed55c0860a97bb62a2f2c363" == cshake::xof(256, 33, x"97ca560bc7a3dc8219b725797a581dd7c28b15ecd39d330785feb4b1228423fb98011ea41c5416da989720d622323d53be1c50f35b92beb56e7260dd7e751a3a8e47", "cv5E7 W~^WC1!ZJ; MAmo1'{`j6X/]2O"));
	/* tcId 84 */ test::@check(x"6a43d4816ff231a8a0843622e8612bef824e844a7995d8aeb061767a54dd41de07" == cshake::xof(256, 33, x"7f9f1976b2a2d73ac24ebd2c53caa533a35b67b60c4f89b35df136577f77e5ef85b5b221e3b63e9fec5a9938eb8a1e28771a7be167354d31c0fc2cf041c4955c87a9b7", "3imMVe>MTz`|O 5mrZ}fQX%8E`IKM9b@(lTs?AQO/<#KkQ8p!7=]YkwXdT)u;q <8?"));
}

fn void cshake_empty()
{
	static String[][] expected = {
		{
			x"7f9c2ba4e88f827d616045507605853ed73b8093f6efbc88eb1a6eacfa66ef263cb1eea988004b93103cfb0aeefd2a686e01fa4a58e8a3639ca8a1e3f9ae57e235b8cc873c23dc62b8d260169afa2f75ab916a58d974918835d25e6a435085b2badfd6dfaac359a5efbb7bcc4b59d538df9a04302e10c8bc1cbf1a0b3a5120ea17cda7cfad765f5623474d368ccca8af0007cd9f5e4c849f167a580b14aabdefaee7eef47cb0fca9767be1fda69419dfb927e9df07348b196691abaeb580b32def58538b8d23f87732ea63b02b4fa0f4873360e2841928cd60dd4cee8cc0d4c922a96188d032675c8ac850933c7aff1533b94c834adbb69c6115bad4692d8619",
			x"7f349b68ef1f45d3767c5f20821f43943655f89a88dd33429ba62e72cdcccf5dcb06755d52836b280be15d4f4a33f81d0913bd7dc7f7d90eeb88ca0e8701e891bc1965098679b0866837414500ddf0a6771b733b647e50993210d071a2ec9248513b0e58ca97ada6e755466ea5737c37c537cabda839472dd2dd1539d658c5c5ec6e998d8d3e38a8283dd705dc938bfe46f8f048628ed1c33587801b2dc8a35ff5847411c8fff1b5c5cd595b03a3c39e16732bfe07cb527ff42ea2c33394212d36611c3be792259acbabf8a9cd30de9fd6e003475669468dd08cc37c07b5339db6ac06855371646b306b2159f5e41fd4669a07387e98871bebbaa0e1f6cad804",
			x"11f59d5bc1463b58b59db4dd19f81c5dd9dafd3fa1bccc1c0bb4fbeb7da8211aa9b2021d1b5476492a2691e61ba91967c5abf7c038e06db881473c97aee2cc00235d9cfb76de83e49e1f378694c35ba8787316bffd2ac0a1cfd4da7a7ed3107e6b3b7b130b280b497200a2992af190d306640aafcc249740d98b60f755f96efb1aca6d5afe146325f86c84fa9a09dcbf9257035edfb89760c6c1c098d692253b655707f4f25021735e9760dbaa853e5a5255a779b1bd99fb9f3b1a37ad7b60559158e79d90ec46f47997581500d2694b0f0a69b726eecf815de128a6edbb254149086a3beb42a7902b1aed9b243bd0679479134d3122c7ec85513d3765ab7efc",
		},
		{
			x"46b9dd2b0ba88d13233b3feb743eeb243fcd52ea62b81b82b50c27646ed5762fd75dc4ddd8c0f200cb05019d67b592f6fc821c49479ab48640292eacb3b7c4be141e96616fb13957692cc7edd0b45ae3dc07223c8e92937bef84bc0eab862853349ec75546f58fb7c2775c38462c5010d846c185c15111e595522a6bcd16cf86f3d122109e3b1fdd943b6aec468a2d621a7c06c6a957c62b54dafc3be87567d677231395f6147293b68ceab7a9e0c58d864e8efde4e1b9a46cbe854713672f5caaae314ed9083dab4b099f8e300f01b8650f1f4b1d8fcf3f3cb53fb8e9eb2ea203bdc970f50ae55428a91f7f53ac266b28419c3778a15fd248d339ede785fb7f",
			x"39d0f1e2a56714e3e06139f93e483da15fd52c9dc1bc30f179576c4b04e3eb59eb6df6df536ec3640dbc06b7926717ce6ff0fa8ffaf80a21c6952fd352a2c2bd45435a73077628796733c28030b586edb738bf8ed936cad302b3ef88dbb7ffb6b07eb4efd592c3956ad467a20a51db4fb3e26014919e8ecc9cdd0e1247bce7ae05e5a4fad78ba8432be99d9d98c26bdce36272d6f905d1f2280a83160115b19aed84b9b54b67b65099c96956b29196a2383aa614c9dfc14632737e0036b1a432bca8ce34d35295238ccc13acac9303620d9def112432945e1a9612ebae22f8ddd0cb4bc85a258469a59398172e438759ebfa2645f9ded33128ea23df8905d86f",
			x"6e9ab01895bcf881ad5930bf8c15a0e5b79f10e6177b981f42c09c9ad0b26d20c82f7cbffb01833e51774e3dade3c22602985717506c7ba2a98c4aa305014c2255749b000aa14df3903ffd2f1d72c3be7f0bb6549a1fec4f992f4eaaa56dda7f3ac6fc7320bd37b2837578bbafcea7fca2ae20dfffdeb4e61dce20b30c0e23f0eb9b2abded87378037968bd269550b523a2bb82a97544719feac3574ca1ea5406f51496f168ffc20f855e9a937878c7386f836ca2b889e56f5fa530fe2a7cc444ee165a34295439e44ffddf690b6637f977b608e02e7eef0933ce6f06bcbbdec933dcd7b69092c7787e8480606bb647bc3e5d747843f9133a3cb5ee90c53ee2a",
		}
	};
	$foreach $j, $c : tests_common::CUSTOMIZATION_STRINGS:
		test::@check(cshake::xof(128, 256, "", $c)[..] == expected[0][$j]);
		test::@check(cshake::xof(256, 256, "", $c)[..] == expected[1][$j]);
	$endforeach

	// One final test on an empty customization string, but with a "streamed" context.
	//   Non-empty customization strings are used in a separate test.
	static char[256] result;
	CShake{128} c1 @noinit; c1.init(NONE, ""); c1.update(""); c1.final(result[..]); test::@check(result[..] == expected[0][0]);
	CShake{256} c2 @noinit; c2.init(NONE, ""); c2.update(""); c2.final(result[..]); test::@check(result[..] == expected[1][0]);
}

fn void cshake_simple()
{
	static String[][] expected = {
		{
			x"d6b9bdbda14c3858c36d5af417fd083bfc8b19b0bf535831a09a057d9b6e6e423b0b04230cd9427a652bbd85d28e72eb176a3fa9d0348da2d823a9befa9ef95c", // c128
			x"de46e887727353da377b63ed4e7b4725d1819442ae7284f691d413e81de03e2acc55c6e73d857e5396b3df15def4c904ae57010a568068568175c40aaece6c68", // c256
			x"a0e35d3cbd3a51951bc796f7c7d0d2a3372880165d4a5ba7cb4dca6bd785870020da36ed276acf3cf69f0a95495d24b293da72c5fa05c09218da3e19c55bfab5", // c128
			x"c848f5bd490c58b5d58a3d27f8abd487835e27706944fe55476cc695bdd5af426e47ef265a1bc4cd9674400401440774f9077e6c11e7975f3be98fb7f3f36ef3", // c256
			x"4bc8f4ed9f750ed3b6c36b0380486039caa99596d4bf8ae6ddd19c46fb5e4d3d8a4bb9e6692d77ad0411012d78e6d56c4e773c97f475aff93e7ef87237b32403", // c128
			x"2905ebe9440fcc60e513c4de64b218fc2123f9f124a178ddbf1b52b5225c7b36d8d1819a79f97287b92eeff6e322b9dac30273c87b9825419db31aaf6a2a6024", // c256
		},
		{
			x"961c919c0854576e561320e81514bf3724197d0715e16a364520384ee997f6ef3be7ad1ab687d31ebd7e6604ef2c7652932e4206113d263514e72f31f5e1df87", // ...
			x"b7b78b04a3dd30a265c8886c33fda94799853de5d3d10541fd4e9f4613701c61075249bed16b0781108fcfe086dbf38a7fb8300807cea85cc649328d07d4ff2b",
			x"a6fa0d44752b2a0c1fe47954f8e428c70f8739f885b9fe5421530d8e78dcd62624ed18c1adde068bb4e66e44b1b64b1fab922b27b469e9715daa5212a9b1ad3c",
			x"aabc0bddd201ed835d119bdab4b1acba24bed792d64d9ed97b28e6a2efd7f3c4cab067f86831c2d7521997d5c564432fa3bbaabda44ec51f0bc977908bf97e1b",
			x"c94e402fc0ab530ea93da7b19212fab6357409390b10b49de14b8eb19d4729431416cf5b921df1a3a5cd5694af4f4f37b65fed57c4d032de8bf193a8255d1a43",
			x"caf922c68f0ef1be137ff4f7b1c629162800274e7815b86e1ec638da05d9ad032da65dd03a51869688d85d1f0dc4c8e98b51e3b0f8665b2755cb4cd3984a1fae",
		},
		{
			x"5b3b6a587417f8fa192aba21c16b7b7a6375aac5f04e950f82bc4773a83e99d977258850244748065ffeb53dee9220e9bc39ee319f49570acc91d29dbd9e5000",
			x"fa8775b64bf3aaf10d7f473c460f4d2361f56ff34ae7267a79409ff09d4f762020a9fddc23dc80f727d17c522f398ce574589f708cb3db1498ae53258c58fa98",
			x"f5798be7955b92fed53c0b46b3888d2a6d7cc4553aab85d8cb4dbb86b33fd148ff8eeafb67528fe83470b50bbf304d30bfc7341695b4ccfa1abc14d278585bb0",
			x"49ba2fa4c283b383948f5804063e3691cd60435fef97414ce9a61fb9740a813185a2c702b3793da5b98de34a19d25e06f5db94b8be832dbb4f14849832528fb0",
			x"b044a324c5fb76f53a22cbc733e663ad17688661d0fb96054f4c03b808c771f51df5aa448a3a0995cc9b35a33aef4323adb6ae0e15b0321ae214903b8b1122e4",
			x"3a8f1babdc3769d47bd2fd68c015130a76843c93daaad11ebfa2d616a84deaf8331526603c1dbae337d1a156c9205062e8076808aafbaa7327ea31edec79df38",
		},
		{
			x"f4202e3c5852f9182a0430fd8144f0a74b95e7417ecae17db0f8cfeed0e3e66eb5585ec6f86021cacf272c798bcf97d368b886b18fec3a571f096086a523717a",
			x"2f671343d9b2e1604dc9dcf0753e5fe15c7c64a0d283cbbf722d411a0e36f6ca1d01d1369a23539cd80f7c054b6e5daf9c962cad5b8ed5bd11998b40d5734442",
			x"522f433e0198bd01421eb0c9ff5ef9d9202573df8d772b5cc0ab857b1e0af4cd347a64a4eb921101b7d3e94947698c6ffef5af1076a327d2356d8019edd2e4e0",
			x"2583af15909aacc58ba75a2434a26206a4c1e730506276b9e41378522ddffae2ab270f491064c452cdc99665d96ad4dd4a47107feac9c25f357491e05cb970a7",
			x"233d462108336eafa76d3812ed06a07d709358c717ba6fe0ce007503dd179d23145ec25535aa15d114f6b142b144363f2afed9be8e7b25f30a3812f6e29c968f",
			x"2952dabf5c13eb575b0a950cd24dc8d9cd3216d3f11708bd5def3b06f1ef06277ef2720bc22afbe8b892497772db3ea11b4f51a1906c7e879eb05b076dea4197",
		},
		{
			x"10cb31367df9831df09c538011c620fe820ed6dbaf2302b75f8922abfa2f239f3c81deda2fad54db2f191485a01aaba679d9ad2db16a9983c9919fd1ec5e1800",
			x"d438d1a7d4363e18665acd10151bc2aee1834a9fa463002e81efc3eb5d35553fd12f957c75b21af20fc2f6dd307a6c8704a4326d20d9068fd678555eb436f86e",
			x"f898e9222e8baa886af507a7ece3ec4bdcb4d0efe524a3da69e134ff06ac420d655e80587652e24361c43c280d564c6a0d8ae53ee5f1dff881cd0b9c9682cfc1",
			x"c2383aa5f11aa56c22e0547cd89ecd2fcd9ca069b3db5f917fc9f26cda32b86c8b4d4821f3bb472a236804cb2fb6082b74c7a5f5407f33088cf9eaa1e32fdf56",
			x"f6e639fd1b83df90f489812fbae6d3738816dc1bb909fc604b6dcf029852fdca44f07e0d661f9500b6ef0cb64082fb6f819d807b34959e7cf70ccc4f92cb2042",
			x"4e3982f283a1e12ba97efd14c7bc84f0cefb62dd985aaaee0ca25a7b699979bc94e75ca19cc6f0cf6a2cf670c1ad02dcda0298451e01cec7adb960b687090e72",
		},
	};

	foreach (i, v : tests_common::SIMPLE_VECTORS)
	{
		foreach (j, w : tests_common::CUSTOMIZATION_STRINGS)
		{
			test::@check(cshake::xof(128, 64, v, w)[..] == expected[i][(j*2) + 0], `128(64): Failed on vector "%s" (c: "%s").`, v, w);
			test::@check(cshake::xof(256, 64, v, w)[..] == expected[i][(j*2) + 1], `256(64): Failed on vector "%s" (c: "%s").`, v, w);
		}
	}
}

fn void cshake_interval()
{
	char[257] x = { [0..256] = 'a' };

	String[][] expected = {
		{
			x"85c8de88d28866bf0868090b3961162bf82392f690d9e4730910f4af7c6ab3ee4354b49ca729eb356ee3f5b0fbd29b66769383e5e401b1f85e044c92bb5231aa", // c128 - custom0
			x"867e2cb04f5a04dcbd592501a5e8fe9ceaafca50255626ca736c138042530ba436b7b1ec0e06a279bc790733bb0aee6fa802683c7b355063c434e91189b0c651", // c256 - custom0
			x"0ab8001e309792c40b99046770f042b20a7d9f8ecac20f307ece77516de6921669dd4ad3ae14133bdabf4254051542ba79948beb48c5336897b6605493fc246a", // c128 - custom1
			x"1812ae91f542a99be0c9825fbc6be2b22ff240cda30e7397f411aa1325ca5104fc1fe22b99146461a15582d0b2fc2652b56578d7dfedeff6c73157ad5f764fc7", // c256 - custom1
			x"cb20f277a40df6245e5cac45778fe5cf915208c0a90447e13d137a6d8695f1a5b95cf8d4c75918497e061c4eb0a76212cc70c86229b9febecb3026a45e957146", // c128 - custom2
			x"6385f3d1e0981e59143faa2b9cb584397112a2b48b9d9ef2267ff5b6e951ee65b89668f30e6d2fe7fa1b3fc2b995c0f116756b1136d53cfa8306af5a0cc2075f", // c256 - custom2
		},
		{
			x"c5756758b525c25a7ded2d3d78ff3e7af54e151d2911b0a9d3470083cbdc41484694ef82bcdf9da94f07c1971d76cc9a79060c248d179da8c17af59c5923cc5d", // ...
			x"df3b2b490c91687b6d7e62b5794dffaff7836cb4bdcd3d995a0aaf83d4e22b408c8f884d941e2a46813c18e5379167ae9ed4140c3fb3ec4c65c3490582dc69b4",
			x"5aa8fb9b68ce1184c7df3f5598a16235dc48ebb096a86999c0f9addbdb2fff29a114c2751334256375028da67ee329132d81dd3547423849d37b58c81f8e37d4",
			x"69cf47a8990410ee742bc7cb1dae2767ea4f78813413c2a46e9280c9f7c73f7c12ed03a261a550081ea905ad5edfe189150448b6df1682363293dec72b756151",
			x"45add629a89a17c085ea75c0232a3244bdc906061e9af8e664c9650a4c8b56924c5392159303d5e2be42f0b90590075b55ab846744a29395789ab2628c0d610d",
			x"a7c6c674d58cd78bcf21d71ba5bb90a61dda4b8debe06a2334562134187b4fd2c6e3313dd473050e11da5f0bf18cc7c02f2f38fe1b150489f90a145350c79546",
		},
		{
			x"81e1c5431818c6b53881d11d892d50cb904dc8c82eb4ec2e24fd03fa795e383b65812ed8735823cd16a1e04330fec1beba32e1acc94b9b06905d20cc1f254564",
			x"e478ad702bc6ca248f8a07ab7937c6d767287c83d32c363e4c4eac48262e66f6c9922ea02d907a02f873c4d48cb8b66536e4ef538d33865f5bbabb0c9a40c161",
			x"8dfca0084018511a4c7fc23a1604f8c9e1ea5e0ae329d37f3596e53e6ba7b2bdc6d1767f8243a0e235deaa269f1fb4c2c3be233dcc92a5be5ee7b8a4a28bd36b",
			x"adc4af908cdee4f24b11e85df6b263b502fa9c545c90a58974f97f79e8e6dba784b6e09bab3769859fd7de9e564d84da7403c4e1280401a03007bad7eb94a679",
			x"5eb0ee2072a576a9dee7d9952eabe3e7a6486c5b168991747f28a21260f988ebf70068ae31748a3fb8d88c7b5b70c4d6e7885c7df5d4f4c6a080b18efb5bb6bd",
			x"fcae5475849d51c8119f343ed0b5e2ce7113c18034bde64d2d24ccdd84837d018ed9418fdd6797a9a6a1bf0529ff44fa75f4524568d34a99f19715a7f7a81124",
		},
		{
			x"1836796fb8a6ca6a172eef75e7c24a95e0d3c107d6e90c5c821b77629a8357464f5be88bed8a2a65e4852005c44aae66812162b3e43e74f974a177d269ae7c7a",
			x"80cad9b26e7391c85da5276fcfa590be59271771664a12fc13fdfd9bf0fd9a6ef111ce51c69c103839ad1e31bf3740d3480284430cc260da8a93c136f96d7820",
			x"e3127af8ac0cd2e4bde585e3e5c6c3e80264ed991cd921077797a4563ce19a900a673f5ea90421b69ac8fc96fcdfa13dd8017a236b4a7ec5e366ec53941e4339",
			x"f48b68643e0e29cbfdc5927e7979bfcbee355d96e838b60037821df9c7e58338cc5048135ccc00f7fbf74f961170f32d5f256a7089acafb04fd84badc6eff544",
			x"0be47eee53efcd86d79702119972b2745c2bb85330295e0ea36e66081ca067d5b263cde379d25b3efab577a65228fc8e3695c8b4de0d989d50d98ec06173acdc",
			x"15ca4509d06f571a80adce874aa5ca055c9b754578d0c3dfef985ccae921d36001b6c233eb06475e0e6d3a56cb066b584c2f5b8ca8fb9dccfd2f65e6d2db6446",
		},
		{
			x"61803382dd6a0fda161539922e89fc29213a1ad3108b5f797f8759b87cc3809d04b728a10008fd1b9f2fdb649b62932d47b35fc91bb1ba96c8b2ae7976b2fd92",
			x"013c4d9eeb21ae8f6114dd600d3ffa7ccdc3003488971b09dbf9c695e9e0d422be3020517ef89a1c750af7710ad0fbfd21e3203d6beea30ce924e467d76b6145",
			x"efa5d3c9cd95fed0fbfef4f4197fb6ec3ffaad37502d2dfc8b5db5201ee1c8364b0e21650a008d3275659e1cfcbf4d600d539e330fe110a50fcdbed741d21d97",
			x"61cc05ea857744fdf0f30b353c4f608377e05c5ab3cf159fb9a715d5417d6c25b1ff508c34e4ec4cc9ebced8619b64234631d839a0c1d7a22a6924b0b38d8fce",
			x"1a7d2c531726ef567e55f18b443a4dfb2576bfbf8d4137e0aa98bb39dfc2757a3260c8e32bceb56bcfda09cb81f0b77ec45b7418d099b73432cc76f234ef515d",
			x"0cc0cb2fdf46aaa54a1b20e36d3d7749c7c7fc75af17cbbf0c128a1465176c1eb2ee4bbd75573e25a17b558a44ba0e88831e3956865e80eff064192269d28f60",
		},
	};

	// 'a'-array of lengths [1, 65, 129, 193, 257]
	for (usz i = 1, usz j = 0; i <= 257; i += 64, ++j)
	{
		foreach (k, w : tests_common::CUSTOMIZATION_STRINGS)
		{
			test::@check(cshake::xof(128, 64, x[:i], w)[..]  == expected[j][(k*2) + 0], "128(16): Failed on length %d.", i);
			test::@check(cshake::xof(256, 64, x[:i], w)[..]  == expected[j][(k*2) + 1], "256(16): Failed on length %d.", i);
		}
	}
}

fn void cshake_streamed()
{
	String s = tests_common::STREAM_VECTOR;

	CShake{128} s1; s1.init(NONE, tests_common::CUSTOMIZATION_STRINGS[2]);
	CShake{128} s2; s2.init(NONE, tests_common::CUSTOMIZATION_STRINGS[2]);
	CShake{256} s3; s3.init(NONE, tests_common::CUSTOMIZATION_STRINGS[2]);
	CShake{256} s4; s4.init(NONE, tests_common::CUSTOMIZATION_STRINGS[2]);

	s1.update(s[:20]); s1.update(s[20:10]); s1.update(s[30:1]); s1.update(s[31..]);
	s2.update(s[:20]); s2.update(s[20:10]); s2.update(s[30:1]); s2.update(s[31..]);
	s3.update(s[:20]); s3.update(s[20:10]); s3.update(s[30:1]); s3.update(s[31..]);
	s4.update(s[:20]); s4.update(s[20:10]); s4.update(s[30:1]); s4.update(s[31..]);

	char[16]  s1_hash; s1.final(s1_hash[..]);
	char[256] s2_hash; s2.final(s2_hash[..]);
	char[16]  s3_hash; s3.final(s3_hash[..]);
	char[256] s4_hash; s4.final(s4_hash[..]);

	test::eq(s1_hash, x"d584563fe65ac9e5aba831e20575f9ec");
	test::eq(s2_hash, x"d584563fe65ac9e5aba831e20575f9ec9e4e4f6421b615ca6eb68fd03abfe897466808986a717758bc9d409e97e1f8a176f5077a75006e3bb58486eba0b018fae8c501d58c6aec35a32e8ae5ca890b77172da65ed1791c22b8ac6124b291f0662c768a45bdb6703f49505c56a9148a9d9ca8f6525deca3f758b5a9e541936c7e013f284ef9008e034a6d27d9182f2e6842f7ee55bc4ea289d4c909080abcf5cad1b298962c8944242652a2022dabf5ec0d1811b7930be3115a30ff8cf6662a201f245576eb6bf3ea91f7580a69b235939d0be1c2a115c694e68eb7d22d12576a7a374976559f31ec2d2e56b7dcaef23809ecaea45cd0498fc59d92deec802456");
	test::eq(s3_hash, x"596fecda6eba0e003f959de0987c1675");
	test::eq(s4_hash, x"596fecda6eba0e003f959de0987c1675427319230b60528000ed0802c8ecf6896cc799c6188c98e718716f7756f0dbddbd451661ff48d54e93f41f926098aff433840a300867232829366fd2547e7875cf933f9dadb2632af1dd408b347fa3dd5f499a9e5c16fc8e413bc3b30ff547c6cb787cb293f46507b8822a6bb51e312e9d8265a98b8b00a8178a371739b3c5f1b0a582651f1bd9d27faa7517ca0eda2cfaf05103c8186a299d2a344ac844e1f94648a8859f7d6363f71ddd5eb7f6ede6831f2edd17ec23f8311caad8afa0528a0dc37425f6b91e53b70c73943c6740af5930a73389ec96b439516f5c539069a7a981d5224b8464ddbb8cf7923fd36dc9");
}

fn void cshake_large() @if ($feature(SLOW_TESTS))
{
	static String[][] expected = {
		{
			x"9d222c79c4ff9d092cf6ca86143aa411",
			x"9d222c79c4ff9d092cf6ca86143aa411e369973808ef97093255826c5572ef58424c4b5c28475ffdcf981663867fec6321c1262e387bccf8ca676884c4a9d0c13bfa6869763d5ae4bbc9b3ccd09d1ca5ea7446538d69b3fb98c72b59a2b4817db5eadd9011f90fa71091931f8134f4f00b562e2fe105937270361c1909862ad45046e3932f5dd311ec72fec5f8fb8f60b45a3bee3f85bbf7fcedc6a555677648e0654b381941a86bd3e512657b0d57a7991fc4543f89d8290492222ce4a33e17602b3b99c009f7655f87535cdaa3716f58c47b8a157ad195f02809f27500b9254979311c6bb415968cd10431169a27d5a8d61e13a6b8b77af1f8b6dd2eefdea0",
			x"3578a7a4ca9137569cdf76ed617d31bb",
			x"3578a7a4ca9137569cdf76ed617d31bb994fca9c1bbf8b184013de8234dfd13a3fd124d4df76c0a539ee7dd2f6e1ec346124c815d9410e145eb561bcd97b18ab6ce8d5553e0eab3d1f7dfb8f9deefe16847e2192f6f61fb82fb90dde60b19063c56a4c55cdd7b672b75bf515adbfe204903c8c0036de54a2999a920de90f66d7ff6ec8e4c93d24ae346fdcb3a5a5bd5739ec15a6eddb5ce5b02da53039fac63e19555faa2eddc693b1f0c2a6fcbe7c0a0a091d0ee700d7322e4b0ff09590de166422f9ead5da4c993d605fe4d9c634843aa178b17672c6568c8a2e62abebea2c21c302bd366ad698959e1f6e434af155568b2734d8379fcd3ffe6489baffa6d7",
		},
		{
			x"6935e13efa6c4f6987d2ec623252fd39",
			x"6935e13efa6c4f6987d2ec623252fd39a728b589f63e2e2b3840e108f811fecfaffe0bb8119fb86690fe978d70d7e8ab9bd5842edc0d2caf4d6aa0c7d068effce209219a014d61215d92065b1eb4e4e231ab4738cdda9e3d60c107dc235fca1838cd669daee91c68e803854d067f8336127f5fea7b35fcc8134296db949a68bcce4f8420ca168b0ec4bee081b878150a9bb023d872eadcc9629d72faa17287c4265f2dc5eb7755f08a2de152e25d52277328d4ca675f04297976738eb2fafbef847493d8e5f92d58b2df2fd4bd534b33e988f4c95e608ff8d059c3587ad60340990ed99db3a98eb4a826d9ba495289f976b8a5dc00bee5ff6715b304b81f3222",
			x"a4ce0ec0ec97ded6996a46a7f244fdf4",
			x"a4ce0ec0ec97ded6996a46a7f244fdf4efd831c47d17a3ca47c788dc6a084bd7b204554f8681172514173ff091b7bee517bef7b9b290bae072a62c5094d210fd1a80e126789d2e5eff1851af7b52eaef2359147a6cfcc598cbc9e381488930ed2fb27b649d52db1a6ce805c415aea772dd132c1058fc5fff241c6f8fe002b269c234b616c21431b0556645f79dfa000fdf5eec2d0b3032ad7134365e1a127e806050f4d140bb1c50d0591d110b41a5ebfa451c11c2b5300a2d91d7590a5ff135425c720af091da0579f64ca9fa0119289a8dbef435c5455598c57776f2b9a80ab45007c28dd5220e79a38de4b0ade06d1ff86f883a3ac7ef433e116b7257e069",
		},
		{
			x"225cdb8c42b0fff05bb6f8623020d1ef",
			x"225cdb8c42b0fff05bb6f8623020d1ef5fd4b4f48a25bbe8e2b0e449fbfbd570b236f073868a3cf051a38938d6418069f2cfc2912fd2584d292a6bfd9392e8781dc7bb17fab4e0f9da558af05ba862c9f9e70a49c91a54670d15f5d049264a427d67b24db28f7ceac2aa68b3ab81e98bd8f380d2fd920f4a3b65ae9ae04e9907e2146b3462b8395e0dcef4570d2179f0ee07aa8999182f6d4bcdbf1ee51a8681296909f8ed14710da02719a268e31262de07e8c2c54b8cb2fad95008220e0633a62ad5a5c40c4fa1c2b531b6058f7c1275ce59c894992553dd91bc3badf1f33cd7f8a1b29ad954a08511b2d0aee901bd6684ce2cfaa94b6c8fe013f398575d16",
			x"d69e9fab0fe8b6fc7c2bcf56cce5fc08",
			x"d69e9fab0fe8b6fc7c2bcf56cce5fc083db30767bc12d5ac482f5b4302068f2c1b2fa92327d30abdfec106af333fac39a05e219f7e8a8aa94dd2a7e1d146385a5b2e30caf16de636e616954b227a0e8306782b5f4ef1e001a1e7da4b00705f3d7577a239beb03ea53833bfcb6ff835634f92c5c4dac629e8048a09a6987eb3737a98285ac51d26b966f1966be9aab3fcfa83bde61aa03a5264019d7e9bd845056257b1e73ccd5a6058aa982d0ec5fec7b9ba0325a4a2b4670fa285e83abe2de9c86f92a072e688baa038e71c0c3a5ecfe21457eb52db08952468f1b91595de420a954062ea3c9b20cf9e689c6421cdc83a7096bdbd8cbde5e469c5618b91456b",
		},
	};
	char[] bigboi = tests_common::get_bigboi();
	foreach (i ,v : tests_common::CUSTOMIZATION_STRINGS)
	{
		test::eq(cshake::xof(128, 16,  bigboi[..], v)[..], expected[i][0]);
		test::eq(cshake::xof(128, 256, bigboi[..], v)[..], expected[i][1]);
		test::eq(cshake::xof(256, 16,  bigboi[..], v)[..], expected[i][2]);
		test::eq(cshake::xof(256, 256, bigboi[..], v)[..], expected[i][3]);
	}
}

fn void cshake_successive_xof_operations_128()
{
	static char[] expected = x"24b35841243321afa4362e8d6cd48acfc5955b1e15e7c8bf8b95d77d30ee1a2f";

	test::@check(cshake::xof(128, 32, "", "beep")[..] == expected);

	// Now use the cryptographic XOF functionality to squeeze variable-length data out of SHAKE in .
	//   We "squeeze" 8 bytes at a time, and the resulting value of the XOF, when concatenated, will match the expected value.
	char[32] buf;
	CShake{128} k;
	k.init(NONE, "beep");
	k.update("");
	k.squeeze(buf[0:8]);
	k.squeeze(buf[8:8]);
	k.squeeze(buf[16:8]);
	k.squeeze(buf[24:8]);

	test::@check(buf[..] == expected);
}

fn void cshake_successive_xof_operations_256()
{
	static char[] expected = x"8e4625ac08758e52b27aa43bf630e78271d6e035f075bdfb8ef2677dd5929c3295a62d81cf2e0302d38612bf1f0810059dfc5f";

	test::@check(cshake::xof(256, 51, "sugar", "beep")[..] == expected);

	// This one shows the even though we squeeze at odd intervals, or beyond the length of the original expected value,
	//   the prefix will still match.
	char[128] buf;
	CShake{256} k;
	k.init(NONE, "beep");
	k.update("sugar");
	k.squeeze(buf[0:7]);
	k.squeeze(buf[7:13]);
	k.squeeze(buf[20:20]);
	k.squeeze(buf[40:1]);
	k.squeeze(buf[41:3]);
	k.squeeze(buf[44:9]);
	k.squeeze(buf[53:10]);
	k.squeeze(buf[63..]);

	test::@check(buf[:expected.len] == expected);
}
