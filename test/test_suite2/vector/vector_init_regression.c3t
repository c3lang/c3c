// #target: macos-x64
module test;
extern fn int printf(char* format, ...);

fn void main() {
    float radians = 3.1415 / 4;
    float[<3>] axis = {0.0, 0.0, 1.0};

    float cosr = (float) $$cos(radians);
    float sinr = (float) $$sin(radians);
    float x = axis[0];
    float y = axis[1];
    float z = axis[2];

    float[<4>][4] a = {};
    a[0] = {
        cosr + (x * x) * (float) (1.0 - cosr),
        (x * y) * (float) (1.0 - cosr) - (z * sinr),
        (x * z) * (float) (1.0 - cosr) + (y * sinr),
        0.0
    };

    a[1] = {
        (y * x) * (float) (1.0 - cosr) + (z * sinr),
        cosr + (y * y) * (float) (1.0 - cosr),
        (y * z) * (float) (1.0 - cosr) - (x * sinr),
        0.0
    };

    a[2] = {
        (z * x) * (float) (1.0 - cosr) - (y * sinr),
        (z * y) * (float) (1.0 - cosr) + (x * sinr),
        cosr + (z * z) * (float) (1.0 - cosr),
        0.0
    };

    a[3] = {
        0.0,
        0.0,
        0.0,
        1.0
    };

    float[<4>][4] b = {
        {
            cosr + (x * x) * (float) (1.0 - cosr),
            (x * y) * (float) (1.0 - cosr) - (z * sinr),
            (x * z) * (float) (1.0 - cosr) + (y * sinr),
            0.0
        },
        {
            (y * x) * (float) (1.0 - cosr) + (z * sinr),
            cosr + (y * y) * (float) (1.0 - cosr),
            (y * z) * (float) (1.0 - cosr) - (x * sinr),
            0.0
        },
        {
            (z * x) * (float) (1.0 - cosr) - (y * sinr),
            (z * y) * (float) (1.0 - cosr) + (x * sinr),
            cosr + (z * z) * (float) (1.0 - cosr),
            0.0
        },
        {
            0.0,
            0.0,
            0.0,
            1.0
        }
    };

    foreach(v : a) {
        printf("A: %f %f %f %f\n", v[0], v[1], v[2], v[3]);
    }

    printf("\n");

    foreach(v : b) {
        printf("B: %f %f %f %f\n", v[0], v[1], v[2], v[3]);
    }
}

/* #expect: test.ll

define void @test_main() #0 {
entry:
  %radians = alloca float, align 4
  %axis = alloca <3 x float>, align 16
  %cosr = alloca float, align 4
  %sinr = alloca float, align 4
  %x = alloca float, align 4
  %y = alloca float, align 4
  %z = alloca float, align 4
  %a = alloca [4 x <4 x float>], align 16
  %b = alloca [4 x <4 x float>], align 16
  %.anon = alloca i64, align 8
  %v = alloca <4 x float>, align 16
  %.anon120 = alloca i64, align 8
  %v124 = alloca <4 x float>, align 16
  store float 0x3FE921CAC0000000, ptr %radians, align 4
  store <3 x float> <float 0.000000e+00, float 0.000000e+00, float 1.000000e+00>, ptr %axis, align 16
  %0 = load float, ptr %radians, align 4
  %1 = call float @llvm.cos.f32(float %0)
  store float %1, ptr %cosr, align 4
  %2 = load float, ptr %radians, align 4
  %3 = call float @llvm.sin.f32(float %2)
  store float %3, ptr %sinr, align 4
  %4 = load <3 x float>, ptr %axis, align 16
  %5 = extractelement <3 x float> %4, i64 0
  store float %5, ptr %x, align 4
  %6 = load <3 x float>, ptr %axis, align 16
  %7 = extractelement <3 x float> %6, i64 1
  store float %7, ptr %y, align 4
  %8 = load <3 x float>, ptr %axis, align 16
  %9 = extractelement <3 x float> %8, i64 2
  store float %9, ptr %z, align 4
  call void @llvm.memset.p0.i64(ptr align 16 %a, i8 0, i64 64, i1 false)
  %10 = getelementptr inbounds [4 x <4 x float>], ptr %a, i64 0, i64 0
  %11 = load float, ptr %cosr, align 4
  %12 = load float, ptr %x, align 4
  %13 = load float, ptr %x, align 4
  %fmul = fmul float %12, %13
  %14 = load float, ptr %cosr, align 4
  %fpfpext = fpext float %14 to double
  %fsub = fsub double 1.000000e+00, %fpfpext
  %fpfptrunc = fptrunc double %fsub to float
  %fmul1 = fmul float %fmul, %fpfptrunc
  %fadd = fadd float %11, %fmul1
  %15 = insertelement <4 x float> undef, float %fadd, i64 0
  %16 = load float, ptr %x, align 4
  %17 = load float, ptr %y, align 4
  %fmul2 = fmul float %16, %17
  %18 = load float, ptr %cosr, align 4
  %fpfpext3 = fpext float %18 to double
  %fsub4 = fsub double 1.000000e+00, %fpfpext3
  %fpfptrunc5 = fptrunc double %fsub4 to float
  %fmul6 = fmul float %fmul2, %fpfptrunc5
  %19 = load float, ptr %z, align 4
  %20 = load float, ptr %sinr, align 4
  %fmul7 = fmul float %19, %20
  %fsub8 = fsub float %fmul6, %fmul7
  %21 = insertelement <4 x float> %15, float %fsub8, i64 1
  %22 = load float, ptr %x, align 4
  %23 = load float, ptr %z, align 4
  %fmul9 = fmul float %22, %23
  %24 = load float, ptr %cosr, align 4
  %fpfpext10 = fpext float %24 to double
  %fsub11 = fsub double 1.000000e+00, %fpfpext10
  %fpfptrunc12 = fptrunc double %fsub11 to float
  %fmul13 = fmul float %fmul9, %fpfptrunc12
  %25 = load float, ptr %y, align 4
  %26 = load float, ptr %sinr, align 4
  %fmul14 = fmul float %25, %26
  %fadd15 = fadd float %fmul13, %fmul14
  %27 = insertelement <4 x float> %21, float %fadd15, i64 2
  %28 = insertelement <4 x float> %27, float 0.000000e+00, i64 3
  store <4 x float> %28, ptr %10, align 16
  %29 = getelementptr inbounds [4 x <4 x float>], ptr %a, i64 0, i64 1
  %30 = load float, ptr %y, align 4
  %31 = load float, ptr %x, align 4
  %fmul16 = fmul float %30, %31
  %32 = load float, ptr %cosr, align 4
  %fpfpext17 = fpext float %32 to double
  %fsub18 = fsub double 1.000000e+00, %fpfpext17
  %fpfptrunc19 = fptrunc double %fsub18 to float
  %fmul20 = fmul float %fmul16, %fpfptrunc19
  %33 = load float, ptr %z, align 4
  %34 = load float, ptr %sinr, align 4
  %fmul21 = fmul float %33, %34
  %fadd22 = fadd float %fmul20, %fmul21
  %35 = insertelement <4 x float> undef, float %fadd22, i64 0
  %36 = load float, ptr %cosr, align 4
  %37 = load float, ptr %y, align 4
  %38 = load float, ptr %y, align 4
  %fmul23 = fmul float %37, %38
  %39 = load float, ptr %cosr, align 4
  %fpfpext24 = fpext float %39 to double
  %fsub25 = fsub double 1.000000e+00, %fpfpext24
  %fpfptrunc26 = fptrunc double %fsub25 to float
  %fmul27 = fmul float %fmul23, %fpfptrunc26
  %fadd28 = fadd float %36, %fmul27
  %40 = insertelement <4 x float> %35, float %fadd28, i64 1
  %41 = load float, ptr %y, align 4
  %42 = load float, ptr %z, align 4
  %fmul29 = fmul float %41, %42
  %43 = load float, ptr %cosr, align 4
  %fpfpext30 = fpext float %43 to double
  %fsub31 = fsub double 1.000000e+00, %fpfpext30
  %fpfptrunc32 = fptrunc double %fsub31 to float
  %fmul33 = fmul float %fmul29, %fpfptrunc32
  %44 = load float, ptr %x, align 4
  %45 = load float, ptr %sinr, align 4
  %fmul34 = fmul float %44, %45
  %fsub35 = fsub float %fmul33, %fmul34
  %46 = insertelement <4 x float> %40, float %fsub35, i64 2
  %47 = insertelement <4 x float> %46, float 0.000000e+00, i64 3
  store <4 x float> %47, ptr %29, align 16
  %48 = getelementptr inbounds [4 x <4 x float>], ptr %a, i64 0, i64 2
  %49 = load float, ptr %z, align 4
  %50 = load float, ptr %x, align 4
  %fmul36 = fmul float %49, %50
  %51 = load float, ptr %cosr, align 4
  %fpfpext37 = fpext float %51 to double
  %fsub38 = fsub double 1.000000e+00, %fpfpext37
  %fpfptrunc39 = fptrunc double %fsub38 to float
  %fmul40 = fmul float %fmul36, %fpfptrunc39
  %52 = load float, ptr %y, align 4
  %53 = load float, ptr %sinr, align 4
  %fmul41 = fmul float %52, %53
  %fsub42 = fsub float %fmul40, %fmul41
  %54 = insertelement <4 x float> undef, float %fsub42, i64 0
  %55 = load float, ptr %z, align 4
  %56 = load float, ptr %y, align 4
  %fmul43 = fmul float %55, %56
  %57 = load float, ptr %cosr, align 4
  %fpfpext44 = fpext float %57 to double
  %fsub45 = fsub double 1.000000e+00, %fpfpext44
  %fpfptrunc46 = fptrunc double %fsub45 to float
  %fmul47 = fmul float %fmul43, %fpfptrunc46
  %58 = load float, ptr %x, align 4
  %59 = load float, ptr %sinr, align 4
  %fmul48 = fmul float %58, %59
  %fadd49 = fadd float %fmul47, %fmul48
  %60 = insertelement <4 x float> %54, float %fadd49, i64 1
  %61 = load float, ptr %cosr, align 4
  %62 = load float, ptr %z, align 4
  %63 = load float, ptr %z, align 4
  %fmul50 = fmul float %62, %63
  %64 = load float, ptr %cosr, align 4
  %fpfpext51 = fpext float %64 to double
  %fsub52 = fsub double 1.000000e+00, %fpfpext51
  %fpfptrunc53 = fptrunc double %fsub52 to float
  %fmul54 = fmul float %fmul50, %fpfptrunc53
  %fadd55 = fadd float %61, %fmul54
  %65 = insertelement <4 x float> %60, float %fadd55, i64 2
  %66 = insertelement <4 x float> %65, float 0.000000e+00, i64 3
  store <4 x float> %66, ptr %48, align 16
  %67 = getelementptr inbounds [4 x <4 x float>], ptr %a, i64 0, i64 3
  store <4 x float> <float 0.000000e+00, float 0.000000e+00, float 0.000000e+00, float 1.000000e+00>, ptr %67, align 16
  %68 = getelementptr inbounds [4 x <4 x float>], ptr %b, i64 0, i64 0
  %69 = load float, ptr %cosr, align 4
  %70 = load float, ptr %x, align 4
  %71 = load float, ptr %x, align 4
  %fmul56 = fmul float %70, %71
  %72 = load float, ptr %cosr, align 4
  %fpfpext57 = fpext float %72 to double
  %fsub58 = fsub double 1.000000e+00, %fpfpext57
  %fpfptrunc59 = fptrunc double %fsub58 to float
  %fmul60 = fmul float %fmul56, %fpfptrunc59
  %fadd61 = fadd float %69, %fmul60
  %73 = insertelement <4 x float> undef, float %fadd61, i64 0
  %74 = load float, ptr %x, align 4
  %75 = load float, ptr %y, align 4
  %fmul62 = fmul float %74, %75
  %76 = load float, ptr %cosr, align 4
  %fpfpext63 = fpext float %76 to double
  %fsub64 = fsub double 1.000000e+00, %fpfpext63
  %fpfptrunc65 = fptrunc double %fsub64 to float
  %fmul66 = fmul float %fmul62, %fpfptrunc65
  %77 = load float, ptr %z, align 4
  %78 = load float, ptr %sinr, align 4
  %fmul67 = fmul float %77, %78
  %fsub68 = fsub float %fmul66, %fmul67
  %79 = insertelement <4 x float> %73, float %fsub68, i64 1
  %80 = load float, ptr %x, align 4
  %81 = load float, ptr %z, align 4
  %fmul69 = fmul float %80, %81
  %82 = load float, ptr %cosr, align 4
  %fpfpext70 = fpext float %82 to double
  %fsub71 = fsub double 1.000000e+00, %fpfpext70
  %fpfptrunc72 = fptrunc double %fsub71 to float
  %fmul73 = fmul float %fmul69, %fpfptrunc72
  %83 = load float, ptr %y, align 4
  %84 = load float, ptr %sinr, align 4
  %fmul74 = fmul float %83, %84
  %fadd75 = fadd float %fmul73, %fmul74
  %85 = insertelement <4 x float> %79, float %fadd75, i64 2
  %86 = insertelement <4 x float> %85, float 0.000000e+00, i64 3
  store <4 x float> %86, ptr %68, align 16
  %87 = getelementptr inbounds [4 x <4 x float>], ptr %b, i64 0, i64 1
  %88 = load float, ptr %y, align 4
  %89 = load float, ptr %x, align 4
  %fmul76 = fmul float %88, %89
  %90 = load float, ptr %cosr, align 4
  %fpfpext77 = fpext float %90 to double
  %fsub78 = fsub double 1.000000e+00, %fpfpext77
  %fpfptrunc79 = fptrunc double %fsub78 to float
  %fmul80 = fmul float %fmul76, %fpfptrunc79
  %91 = load float, ptr %z, align 4
  %92 = load float, ptr %sinr, align 4
  %fmul81 = fmul float %91, %92
  %fadd82 = fadd float %fmul80, %fmul81
  %93 = insertelement <4 x float> undef, float %fadd82, i64 0
  %94 = load float, ptr %cosr, align 4
  %95 = load float, ptr %y, align 4
  %96 = load float, ptr %y, align 4
  %fmul83 = fmul float %95, %96
  %97 = load float, ptr %cosr, align 4
  %fpfpext84 = fpext float %97 to double
  %fsub85 = fsub double 1.000000e+00, %fpfpext84
  %fpfptrunc86 = fptrunc double %fsub85 to float
  %fmul87 = fmul float %fmul83, %fpfptrunc86
  %fadd88 = fadd float %94, %fmul87
  %98 = insertelement <4 x float> %93, float %fadd88, i64 1
  %99 = load float, ptr %y, align 4
  %100 = load float, ptr %z, align 4
  %fmul89 = fmul float %99, %100
  %101 = load float, ptr %cosr, align 4
  %fpfpext90 = fpext float %101 to double
  %fsub91 = fsub double 1.000000e+00, %fpfpext90
  %fpfptrunc92 = fptrunc double %fsub91 to float
  %fmul93 = fmul float %fmul89, %fpfptrunc92
  %102 = load float, ptr %x, align 4
  %103 = load float, ptr %sinr, align 4
  %fmul94 = fmul float %102, %103
  %fsub95 = fsub float %fmul93, %fmul94
  %104 = insertelement <4 x float> %98, float %fsub95, i64 2
  %105 = insertelement <4 x float> %104, float 0.000000e+00, i64 3
  store <4 x float> %105, ptr %87, align 16
  %106 = getelementptr inbounds [4 x <4 x float>], ptr %b, i64 0, i64 2
  %107 = load float, ptr %z, align 4
  %108 = load float, ptr %x, align 4
  %fmul96 = fmul float %107, %108
  %109 = load float, ptr %cosr, align 4
  %fpfpext97 = fpext float %109 to double
  %fsub98 = fsub double 1.000000e+00, %fpfpext97
  %fpfptrunc99 = fptrunc double %fsub98 to float
  %fmul100 = fmul float %fmul96, %fpfptrunc99
  %110 = load float, ptr %y, align 4
  %111 = load float, ptr %sinr, align 4
  %fmul101 = fmul float %110, %111
  %fsub102 = fsub float %fmul100, %fmul101
  %112 = insertelement <4 x float> undef, float %fsub102, i64 0
  %113 = load float, ptr %z, align 4
  %114 = load float, ptr %y, align 4
  %fmul103 = fmul float %113, %114
  %115 = load float, ptr %cosr, align 4
  %fpfpext104 = fpext float %115 to double
  %fsub105 = fsub double 1.000000e+00, %fpfpext104
  %fpfptrunc106 = fptrunc double %fsub105 to float
  %fmul107 = fmul float %fmul103, %fpfptrunc106
  %116 = load float, ptr %x, align 4
  %117 = load float, ptr %sinr, align 4
  %fmul108 = fmul float %116, %117
  %fadd109 = fadd float %fmul107, %fmul108
  %118 = insertelement <4 x float> %112, float %fadd109, i64 1
  %119 = load float, ptr %cosr, align 4
  %120 = load float, ptr %z, align 4
  %121 = load float, ptr %z, align 4
  %fmul110 = fmul float %120, %121
  %122 = load float, ptr %cosr, align 4
  %fpfpext111 = fpext float %122 to double
  %fsub112 = fsub double 1.000000e+00, %fpfpext111
  %fpfptrunc113 = fptrunc double %fsub112 to float
  %fmul114 = fmul float %fmul110, %fpfptrunc113
  %fadd115 = fadd float %119, %fmul114
  %123 = insertelement <4 x float> %118, float %fadd115, i64 2
  %124 = insertelement <4 x float> %123, float 0.000000e+00, i64 3
  store <4 x float> %124, ptr %106, align 16
  %125 = getelementptr inbounds [4 x <4 x float>], ptr %b, i64 0, i64 3
  store <4 x float> <float 0.000000e+00, float 0.000000e+00, float 0.000000e+00, float 1.000000e+00>, ptr %125, align 16
  store i64 0, ptr %.anon, align 8
  br label %loop.cond

loop.cond:                                        ; preds = %loop.body, %entry
  %126 = load i64, ptr %.anon, align 8
  %gt = icmp ugt i64 4, %126
  br i1 %gt, label %loop.body, label %loop.exit

loop.body:                                        ; preds = %loop.cond
  %127 = load i64, ptr %.anon, align 8
  %128 = getelementptr inbounds [4 x <4 x float>], ptr %a, i64 0, i64 %127
  %129 = load <4 x float>, ptr %128, align 16
  store <4 x float> %129, ptr %v, align 16
  %130 = load <4 x float>, ptr %v, align 16
  %131 = extractelement <4 x float> %130, i64 0
  %fpfpext116 = fpext float %131 to double
  %132 = load <4 x float>, ptr %v, align 16
  %133 = extractelement <4 x float> %132, i64 1
  %fpfpext117 = fpext float %133 to double
  %134 = load <4 x float>, ptr %v, align 16
  %135 = extractelement <4 x float> %134, i64 2
  %fpfpext118 = fpext float %135 to double
  %136 = load <4 x float>, ptr %v, align 16
  %137 = extractelement <4 x float> %136, i64 3
  %fpfpext119 = fpext float %137 to double
  %138 = call i32 (ptr, ...) @printf(ptr @.str, double %fpfpext116, double %fpfpext117, double %fpfpext118, double %fpfpext119)
  %139 = load i64, ptr %.anon, align 8
  %add = add i64 %139, 1
  store i64 %add, ptr %.anon, align 8
  br label %loop.cond

loop.exit:                                        ; preds = %loop.cond
  %140 = call i32 (ptr, ...) @printf(ptr @.str.1)
  store i64 0, ptr %.anon120, align 8
  br label %loop.cond121

loop.cond121:                                     ; preds = %loop.body123, %loop.exit
  %141 = load i64, ptr %.anon120, align 8
  %gt122 = icmp ugt i64 4, %141
  br i1 %gt122, label %loop.body123, label %loop.exit130

loop.body123:                                     ; preds = %loop.cond121
  %142 = load i64, ptr %.anon120, align 8
  %143 = getelementptr inbounds [4 x <4 x float>], ptr %b, i64 0, i64 %142
  %144 = load <4 x float>, ptr %143, align 16
  store <4 x float> %144, ptr %v124, align 16
  %145 = load <4 x float>, ptr %v124, align 16
  %146 = extractelement <4 x float> %145, i64 0
  %fpfpext125 = fpext float %146 to double
  %147 = load <4 x float>, ptr %v124, align 16
  %148 = extractelement <4 x float> %147, i64 1
  %fpfpext126 = fpext float %148 to double
  %149 = load <4 x float>, ptr %v124, align 16
  %150 = extractelement <4 x float> %149, i64 2
  %fpfpext127 = fpext float %150 to double
  %151 = load <4 x float>, ptr %v124, align 16
  %152 = extractelement <4 x float> %151, i64 3
  %fpfpext128 = fpext float %152 to double
  %153 = call i32 (ptr, ...) @printf(ptr @.str.2, double %fpfpext125, double %fpfpext126, double %fpfpext127, double %fpfpext128)
  %154 = load i64, ptr %.anon120, align 8
  %add129 = add i64 %154, 1
  store i64 %add129, ptr %.anon120, align 8
  br label %loop.cond121

loop.exit130:                                     ; preds = %loop.cond121
  ret void
}